---
title: "Analyse OGD Dataensatz Leerkuendingung"
subtitle: "Open Government Data Analysis"
author: "Angelo Duo"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cosmo
    highlight: tango
    code_folding: hide
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

# Load required libraries
library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(scales)
library(forcats)

# Source all analysis scripts
source("../scripts/utils.R")
source("../scripts/01_load.R")
source("../scripts/02_explore.R")
source("../scripts/03_analyze.R")
source("../scripts/04_visualize.R")
```

# Zusammenfassung
Unterscheiden sich Zielorte nach Leerkündigungen systematisch nach Altersgruppen.
Zwischen 2010 und 2023 wurden 8’559 Personen aufgrund von Leerkündigungen erfasst. Rund X % zogen innerhalb der Stadt um, wobei dieser Anteil stark altersabhängig ist. Jüngere und sehr alte Altersgruppen zeigen signifikant unterschiedliche Zielmuster (χ²-Test, p < 0.001), allerdings mit kleiner Effektstärke (Cramér’s V ≈ 0.07–0.09). Über die Zeit bleiben die Zielort-Strukturen bemerkenswert stabil, trotz jährlicher Schwankungen in der Anzahl Betroffener. !!!Todo mach es besser!!!


Diese Analyse prüft, ob sich der Zielort nach einer Leerkündigung zwischen Altersgruppen unterscheidet – insbesondere „innerhalb der Stadt Zürich“ vs. „ausserhalb der Stadt“.
Es zeigt sich ein klarer und statistisch signifikanter Zusammenhang: Jüngere Altersgruppen sind nach Leerkündigungen überdurchschnittlich häufig ausserhalb der Stadt, während ältere Personen überproportional innerhalb der Stadt verbleiben. Damit deutet der Datensatz darauf hin, dass Leerkündigungen je nach Lebensphase unterschiedliche räumliche Folgen haben (Mobilität bzw. Verlagerung vs. Verbleib).
---

# 1. Datenimport und Validierung

## 1.1 Datensatzquelle

Daten stammen vom OGD Datensatz. Siehe die [OGD Website](https://data.stadt-zuerich.ch/dataset/bau_umbau_leerkuendigung_wohnortsgebiete_ag_personen_od5052) fuer mehr Informationen zu den erfassten Variablen.

**URL**: `https://data.stadt-zuerich.ch/dataset/bau_umbau_leerkuendigung_wohnortsgebiete_ag_personen_od5052/download/BAU505OD5052.csv`

```{r load-data}
# Load dataset from official URL
df_raw <- load_and_validate(DATASET_URL)
```

```{r field-mapping}
# Display new names
mapping_table <- data.frame(
  `New name` = names(FIELD_MAPPINGS),
  `Original name` = unlist(FIELD_MAPPINGS)
)

kable(mapping_table, caption = "Name Mappings")

# Apply renaming
df <- map_fields(df_raw)
```

---

# 2. Methodik

## 2.1 Aggregationsmass

Sämtliche Summen, Anteile und Vergleiche basieren auf der **Anzahl betroffener Personen** (`AnzPersonWir` im Datensatz). Diese Variable gibt die Zahl der Individuen an, die eine Leerkündigung erhalten haben.

## 2.2 Kategorien „innerhalb / ausserhalb der Stadt“

Für eine erste Analyse definieren wir eine binäre Gruppierung der Wohnort-Ergebnisse:

**Innerhalb der Stadt Zürich**:

- `r WITHIN_CITY_CATEGORIES[1]`
- `r WITHIN_CITY_CATEGORIES[2]`

**Ausserhalb der Stadt Zürich**:  
Alle übrigen Wohnortkategorien (Kategorie „Unbekannt“ wird separat behandelt). Sie wird **von der binären Analyse „innerhalb / ausserhalb der Stadt“ ausgeschlossen**, um Verzerrungen zu vermeiden.

```{r within-outside-mapping}
# Display residence categories and their classification
residence_classification <- df %>%
  select(new_residence, within_city) %>%
  distinct() %>%
  arrange(desc(within_city), new_residence) %>%
  mutate(Klassifikation = ifelse(within_city, "Within City", "Outside City"))

kable(residence_classification %>% select(new_residence, Klassifikation), 
      caption = "Klassifikation Wohnorte")
```


---

# 3. Exploration
## 3.1 Zusammenfassende Statistiken
Die Tabelle fasst die wichtigsten Eckwerte des Datensatzes zusammen: den beobachteten Zeitraum, die Gesamtzahl der betroffenen Personen sowie die Anzahl  Altersgruppen und Wohnort-Kategorien.

```{r summary-statistics-table}
exploration_results <- explore_dataset(df)
##  Summary Stats
summary_stats <- tibble::tibble(
  Metrik = c(
    "Zeitraum (von)",
    "Zeitraum (bis)",
    "Zeitraum (Jahre)",
    "Total Betroffene Personen",
    "Anzahl Altersgruppen",
    "Anzahl Wohnort-Kategorien"
  ),
  Wert = c(
    exploration_results$time_range$earliest,
    exploration_results$time_range$latest,
    exploration_results$time_range$span,
    format(exploration_results$total_count, big.mark = ","),
    length(exploration_results$age_groups),
    length(exploration_results$residence_categories)
  )
)

knitr::kable(
  summary_stats,
  caption = "wichtigste Kennzahlen"
)

```


## 3.2 Kategorie "Unbekannt"

```{r unkwn-analysis}
unknown_results <- summarise_unknow_category(df)
```

Den höchsten Anteil "Unbekant" weist `r unknown_results$max_age_group` mit `r round(unknown_results$max_share * 100, 1)`% auf, den niedrigsten `r unknown_results$min_age_group` mit `r round(unknown_results$min_share * 100, 1)`%. Das entspricht einer Differenz von `r round(unknown_results$contrast * 100, 1)` Prozentpunkten.
Mögliche  Erklärungen (ohne Anspruch auf Vollständigkeit) sind unterschiedliche Erfassungs- oder Meldepraktike oder "lost to follow-up".

```{r unknown-tbl}
unknown_tbl <- tibble::tibble(
  Merkmal = c("Kategorie 'Unbekannt' vorhanden", "Anzahl", "Anteil"),
  Wert = c(
    ifelse(exploration_results$unknown_info$exists, "Ja", "Nein"),
    format(exploration_results$unknown_info$count, big.mark = ","),
    paste0(round(exploration_results$unknown_info$share * 100, 1), "%")
  )
)

knitr::kable(unknown_tbl, caption = "Übersicht zur Kategorie 'Unbekannt'")
```


```{r unknown_table}
unknown_table <- unknown_results$unknown_summary %>%
  mutate(
    `Anteil „Unbekannt“` = paste0(round(unknown_share * 100, 1), "%"),
    `Anzahl „Unbekannt“` = format(unknown_count, big.mark = ","),
    `Total` = format(total, big.mark = ",")
  ) %>%
  select(`Altersgruppe` = age_group, `Anteil „Unbekannt“`, `Anzahl „Unbekannt“`, `Total`)

kable(unknown_table, caption = "Kategorie „Unbekannt“ nach Altersgruppe", align = c("l", "r", "r", "r"))
```

```{r uknwn-visualization}
plot_unknown_concentration(unknown_results$unknown_summary)

```

---

# 4. Analyse

## 4.1 Veränderung über die Zeit

```{r zeit-analysis}
time_results <- analyze_time_change(df)
```

Die folgende Auswertung zeigt, wie sich die Gesamtzahl betroffener Personen im Zeitverlauf entwickelt. Der Höchstwert liegt im Jahr `r paste(time_results$peak_years, collapse = ", ")` mit `r format(time_results$peak_count, big.mark = ",")` betroffen. Es gibt eine Zunahme bis ins Jahr 2017, mit eineme Ausreiser nach unten im Jahr  2015. Es folgt eine abnahme und stabilisierung der Leerkuendigungen.

```{r tiem-visualization}
plot_persons_per_time(time_results$time_summary)
```

---

## 4.2 Verteilung der Zielorte

Die folgende Darstellung zeigt die Verteilung der Zielorte nach einer Leerkündigung über die Jahre. 2010 fällt als Ausreißer auf während die Verteilung ansonsten weitgehend stabil bleibt.
***Todo testen***

```{r zielorte-analysis}
residence_results <- analyze_composition_shift(df)
```

```{r zielorte-vertielng}
plot_composition_shift(residence_results$composition_summary)
```

---

## 4.3 Altersabhängige Unterschiede im Verbleib innerhalb und ausserhalb der Stadt

```{r age-target-analysis}
# Für diese Auswertung wird die Kategorie "Unbekannt" ausgeschlossen
df_known <- filter_unknown(df)
age_results <- analyze_age_groups_within(df_known)

```

Die Auswertung zeigt Unterschiede zwischen den Altersgruppen innerhalb der Stadt Zürich zu bleiben. Den höchsten Anteil «innerhalb der Stadt» hat die Gruppe `r age_results$max_age_group` mit `r round(age_results$max_share * 100, 1)`%, den niedrigsten `r age_results$min_age_group` mit `r round(age_results$min_share * 100, 1)` %. Das entspricht einer Differenz von `r round(age_results$contrast * 100, 1)` Prozentpunkten. Zur Einordnung, ob sich die Verteilung **„innerhalb der Stadt“ vs. „ausserhalb der Stadt“** zwischen Altersgruppen unterscheidet, wird mit  einen Chi-Quadrat-Test auf Unabhängigkeit (auf aggregierten Zählwerten; ohne Kategorie „Unbekannt“(siehe oben )) getestet.

```{r age-target-visualization}
plot_age_gradient(age_results$age_summary)
```



```{r age-statistical-test}
# Kontingenztafel (ohne die Kat "Unbekannt")
contingency_table <- df_known %>%
  mutate(outcome = ifelse(within_city, "Innerhalb der Stadt", "Ausserhalb der Stadt")) %>%
  group_by(age_group, outcome) %>%
  summarise(count = sum(count, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = outcome, values_from = count, values_fill = 0) %>%
  column_to_rownames("age_group") %>%
  as.matrix()

# chi test
chi_result <- chisq.test(contingency_table)

# Effektgrösse cramers um einschaetzung des p werts zu haben
n <- sum(contingency_table)
v <- cramers_v(chi_result, contingency_table)

# Resultate als Tabelle
chi_table <- make_chi_table(chi_result, v)

kable(contingency_table, caption = "Kontingenztafel: Altersgruppe × Ziel (innerhalb/ausserhalb der Stadt)")

```

```{r chi-table}
knitr::kable(chi_table, caption = "Chi-Quadrat-Test: Altersgruppe × (innerhalb/ausserhalb der Stadt)")
```

Der Chi-Quadrat-Test deutet auf einen Zusammenhang zwischen Altersgruppe und Ziel (innerhalb/ausserhalb der Stadt) hin (p = `r format.pval(chi_result$p.value, digits = 3)`). Die Effektgrösse Cramer’s V beträgt `r round(v, 3)` und entspricht einem kleinen Effekt.

---

# 5. Verteilungen Zwischen Zielorten und Altersgruppen

Um den Zusammenhang zwischen Altersgruppe und allen Zielortkategorien (inklusive aller ausserstädtischen Zielorte und "Unbekannt") zu untersuchen, führen wir einen weiteren Chi-Quadrat-Test auf der vollen Kontingenztafel Altersgruppe $\times$ Zielort durch.

```{r statistical-test-full-categories}
age_residence_results <- analyze_age_residence_distributions(df)

# Kontingenztafel: Altersgruppe × Zielort (O_matrix ist die volle Matrix)
tab_full <- age_residence_results$O_matrix

# Chi-Quadrat-Test
chi_full_result <- chisq.test(tab_full, simulate.p.value=TRUE)

# Effektgrösse
n_full <- sum(tab_full)
v_full <- cramers_v(chi_full_result, tab_full)

# Resultate als Tabelle
chi_full_table <- make_chi_table(chi_full_result, v_full)
knitr::kable(chi_full_table, caption = "Chi-Quadrat-Test: Altersgruppe × Alle Zielorte")

```


Die globalen  Chi-Tests deuten auf einen Zusammenhang zwischen Altersgruppe und dem Zielort hin (für die binäre Klassifikation als auch für alle Zielortkategorien). Im nächsten Abschnitt wird untersucht welche spezifischen Zielorte zu den beobachteten Unterschieden beitragen.

## 5.2  Wo liegen die auffälligsten Abweichungen von Altersgruppen und Zielorten?
Die Heatmap zeigt pro Kombination aus Altersgruppe und Zielort standardisierte Residuen. Werte > 0 (rot) bedeuten, dass diese Kombination häufiger beobachtet wird als unter der Annahme von Unabhängigkeit zu erwarten wäre, Werte < 0 (blau) entsprechend seltener. Auffällig ist, dass 20–39-Jährige beim Zielort „gleiches Stadtquartier“ deutlich unterrepräsentiert sind, während sie bei „übrige Schweiz“ und „Ausland“ überrepräsentiert sind. Bei 60–79-Jährigen, 80-99-Jährigen und 0-19-Jährigen zeigt sich dagegen eine Überrepräsentation im gleichen Stadtquartier. Zudem ist die Kategorie „Unbekannt“ bei den 80–99-Jährigen stark überrepräsentiert (siehe auch Abschnitt 3.2).

```{r fig-residu-heatmap, message=FALSE, warning=FALSE}

plot_standardised_residual(age_residence_results$standardised_residuals_long)
```

Die Abweichungen werden  als log2-Relativrisiko dargestellt und die Über- und Unterrepräsentation quantifiziert. Ein Wert von 0 bedeutet „entspricht dem Gesamtdurchschnitt“. Positive Werte zeigen, dass ein Zielort innerhalb einer Altersgruppe überdurchschnittlich häufig vorkommt, negative Werte entsprechend unterdurchschnittlich häufig.

Für die 20–39-Jährigen zeigen sich im Vergleich zum Gesamtdurchschnitt mehr Umzüge in „übrige Schweiz“ und „Ausland“ (grob ~1.3× häufiger) , während „gleiches Stadtquartier“ unterrepräsentiert ist, ca. 24% weniger häufig als im Gesamtdurchschnitt.

Umgekehrt ist „gleiches Stadtquartier“ bei den 80–99-Jährigen klar überrepräsentiert, grob ~1.6× häufiger. Zusätzlich sticht bei den 80–99-Jährigen die Kategorie „Unbekannt“ heraus (>2 x mal häufiger).

```{r fig-log2rr-heatmap, message=FALSE, warning=FALSE}
plot_log2_relative_risk(age_residence_results$log2RR_long, cap = 2.5)
```

## 5.3 Verbleib im gleichen Stadtquartier

```{r same_quarter-analysis}
# Todo zeige einfach die same share im selben quartier, test
same_quarter_results <- analyze_same_quarter(df)
```

Anteil der betroffenen Personen die nach einer Leerkündigung im gleichen Stadtquartier bleiben. Den höchsten Anteil weist 80- bis 99-Jährige mit 26.6% auf, den niedrigsten 20- bis 39-Jährige mit 12.7%.

```{r same_quarter-plot}
plot_same_quarter(same_quarter_results)
```

---

# 6. Limitationen

- Ohne Bezug zur Altersstruktur der Gesamtbevölkerung können wir nicht beurteilen, ob bestimmte Altersgruppen über- oder unterproportional betroffen sind.
- Der Datensatz erfasst nur Personen mit gemeldeter Leerkündigung und nicht nicht alle Umzüge.
- Die relativen Risiken sind rein deskriptiv und basieren auf bedingten Anteilen, nicht Modellannahmen.


# Appendix: Session Information

```{r session-info}

sessionInfo()
```

---
**Analysis completed**: `r Sys.time()`  
